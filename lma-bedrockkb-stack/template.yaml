# Copyright (c) 2025 Amazon.com
# This file is licensed under the MIT License.
# See the LICENSE file in the project root for full license information.

AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Amazon Transcribe Live Meeting Assist - Bedrock Knowledge Base setup

Parameters:
  pVectorStoreType:
    Type: String
    Default: "S3_VECTORS"
    AllowedValues:
      - "OPENSEARCH_SERVERLESS"
      - "S3_VECTORS"
    Description: >-
      Choose vector store type. S3 Vectors (default) provides 40-60% cost savings
      with sub-second latency. OpenSearch Serverless for sub-millisecond queries.

  pS3VectorBucketName:
    Type: String
    Default: ""
    Description: >-
      S3 vector bucket name (auto-generated if empty).
      Only used when pVectorStoreType is S3_VECTORS.

  pS3VectorIndexName:
    Type: String
    Default: "lma-kb-index"
    Description: >-
      S3 vector index name. Only used when pVectorStoreType is S3_VECTORS.

  pKnowledgeBaseBucketName:
    Type: String
    Default: ""
    Description: >-
      Enter the bucket name of an existing bucket with documents to ingest, or leave blank if you don't need an S3 data source.

  pInputDocumentUploadFolderPrefix:
    Type: String
    Default: ""
    Description: >-
      Comma separated list of S3 prefixes with path to your source documents e.g. "my/documents/here/", "prefix1/, prefix2/"

  pS3SyncScheduleExpression:
    Type: String
    Default: "cron(0 0 * * ? *)"
    Description: >-
      Enter a schedule expression for when the S3 sync should be triggered. See https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html for examples.

  pWebCrawlerURLs:
    Type: String
    Default: ""
    Description: >-
      Comma separated list of public web sites to crawl, or leave blank if you don't need a Web data source.

  pWebCrawlerScope:
    Type: String
    AllowedValues:
      - "DEFAULT"
      - "HOST_ONLY"
      - "SUBDOMAINS"
    Default: DEFAULT
    Description: >-
      The scope of what is crawled for your URLs.
      Choose DEFAULT to limit to web pages that have the same host and the same initial path as the source URLs.
      Choose HOST_ONLY to limit to web pages that have the same host as the source URLs.
      Choose SUBDOMAINS to to include sub domains in addition to the host or primary domain.

  pWebSyncScheduleExpression:
    Type: String
    Default: "cron(0 0 * * ? *)"
    Description: >-
      Enter a schedule expression for when the Web sync should be triggered, or leave blank for no sync. See https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html for examples.

  pEmbedModel:
    Type: String
    AllowedValues:
      - amazon.titan-embed-text-v2:0
      - amazon.titan-embed-text-v1
      - cohere.embed-english-v3
      - cohere.embed-multilingual-v3
    Default: amazon.titan-embed-text-v2:0
    Description: >-
      Embedding models available on Amazon Bedrock

  pChunkingStrategy:
    Type: String
    AllowedValues:
      - Default chunking
      - Fixed-size chunking
      - No chunking
    Default: Fixed-size chunking
    Description: >-
      Chunking breaks down the text into smaller segments before embedding. The chunking strategy can't be modified after you create the Knowledge Base

  pMaxTokens:
    Type: Number
    MinValue: 20
    MaxValue: 8192
    Default: 300
    Description: >-
      Maximum number of tokens per chunk (between 20 and 8192 tokens)

  pOverlapPercentage:
    Type: Number
    MinValue: 1
    MaxValue: 99
    Default: 15
    Description: >-
      Approximate percentage of overlapped tokens between two consecutive chunks (typical overlap is around 10% - 20%)

  pIndexName:
    Type: String
    MinLength: 1
    MaxLength: 63
    Default: bedrock-knowledge-base-default-index
    AllowedPattern: ^[a-z0-9](-*[a-z0-9])*
    ConstraintDescription: Must be lowercase or numbers with a length of 1-63 characters

  pVectorFieldName:
    Type: String
    Default: bedrock-knowledge-base-default-vector

  pMetaDataFieldName:
    Type: String
    Default: AMAZON_BEDROCK_METADATA

  pTextFieldName:
    Type: String
    Default: AMAZON_BEDROCK_TEXT_CHUNK

  PermissionsBoundaryArn:
    Type: String
    Default: ""
    Description: >-
      (Optional) ARN of an existing IAM managed policy to use as permissions boundary for IAM roles.
      If provided, this policy will limit the maximum permissions that can be granted to IAM roles
      in this stack, providing an additional layer of security.

  EnableDataRetentionOnDelete:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
    Description: >-
      Enable to retain vector store data (S3 Vectors bucket or OpenSearch collection) when stack is deleted.
      When enabled, data is preserved for recovery. When disabled, all data is permanently deleted with the stack.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Vector Store Configuration
        Parameters:
          - pVectorStoreType
          - pS3VectorBucketName
          - pS3VectorIndexName
      - Label:
          default: Knowledge Base Data Sources
        Parameters:
          - pKnowledgeBaseBucketName
          - pInputDocumentUploadFolderPrefix
          - pS3SyncScheduleExpression
          - pWebCrawlerURLs
          - pWebCrawlerScope
          - pWebSyncScheduleExpression
      - Label:
          default: Embedding Model
        Parameters:
          - pEmbedModel
      - Label:
          default: Document Chunking
        Parameters:
          - pChunkingStrategy
          - pMaxTokens
          - pOverlapPercentage
      - Label:
          default: Index Details
        Parameters:
          - pIndexName
          - pVectorFieldName
          - pMetaDataFieldName
          - pTextFieldName

    ParameterLabels:
      pVectorStoreType:
        default: Vector Store Type
      pS3VectorBucketName:
        default: S3 Vector Bucket Name (S3 Vectors only)
      pS3VectorIndexName:
        default: S3 Vector Index Name (S3 Vectors only)
      pKnowledgeBaseBucketName:
        default: Existing S3 bucket with knowledge base source documents (optional).
      pInputDocumentUploadFolderPrefix:
        default: S3 prefix(es) for your content (optional)
      pS3SyncScheduleExpression:
        default: S3 sync schedule expression
      pWebCrawlerURLs:
        default: Publicly accessible URLs for web crawling (optional)
      pWebCrawlerScope:
        default: Web crawl sync scope
      pWebSyncScheduleExpression:
        default: Web sync schedule expression
      pEmbedModel:
        default: Choose an embedding model
      pChunkingStrategy:
        default: Choose a chunking strategy (default, fixed-size, or none)
      pMaxTokens:
        default: For fixed-size chunking, choose a maximum number of tokens per chunk
      pOverlapPercentage:
        default: For fixed-size chunking, choose an overlap percentage between chunks
      pIndexName:
        default: Index name to be created in the vector store
      pVectorFieldName:
        default: Vector field name
      pMetaDataFieldName:
        default: Metadata field name
      pTextFieldName:
        default: Text field name

Conditions:
  UseS3Vectors: !Equals [!Ref pVectorStoreType, "S3_VECTORS"]
  UseOpenSearchServerless: !Equals [!Ref pVectorStoreType, "OPENSEARCH_SERVERLESS"]
  HasS3VectorBucketName: !Not [!Equals [!Ref pS3VectorBucketName, ""]]
  IsS3DataSource:
    Fn::Not:
      - Fn::Equals:
          - ""
          - Ref: pKnowledgeBaseBucketName
  IsWebDataSource:
    Fn::Not:
      - Fn::Equals:
          - ""
          - Ref: pWebCrawlerURLs
  # Web crawler only supported with OpenSearch Serverless, not S3 Vectors
  ShouldCreateWebDataSource:
    Fn::And:
      - Condition: IsWebDataSource
      - Condition: UseOpenSearchServerless
  HasWebCrawlerScope:
    Fn::Not:
      - Fn::Equals:
          - DEFAULT
          - Ref: pWebCrawlerScope
  HasInputDocumentUploadFolderPrefix:
    Fn::Not:
      - Fn::Equals:
          - ""
          - Ref: pInputDocumentUploadFolderPrefix
  IsChunkingStrategyFixed:
    Fn::Equals:
      - Ref: pChunkingStrategy
      - Fixed-size chunking
  IsChunkingStrategyDefault:
    Fn::Equals:
      - Ref: pChunkingStrategy
      - Default chunking
  IsChunkingStrategyNoChunking:
    Fn::Equals:
      - Ref: pChunkingStrategy
      - No chunking
  IsChunkingStrategyFixedOrDefault:
    Fn::Or:
      - Condition: IsChunkingStrategyFixed
      - Condition: IsChunkingStrategyDefault
  HasPermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundaryArn, ""]]
  ShouldRetainDataOnDelete: !Equals [!Ref EnableDataRetentionOnDelete, "true"]

Resources:
  # Custom resource to transform input to lowercase.
  GetAdjustedStackNameFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access as it only interacts with AWS services via APIs
          - id: W92
            reason: Function does not require reserved concurrency as it scales based on demand
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      InlineCode: |
        import cfnresponse
        import time
        def handler(event, context):
            print(event)  
            output = event['ResourceProperties'].get('InputString', '').lower()
            output = output[:32]
            responseData = {'OutputString': output}                                            
            cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)

  AdjustedStackName:
    Type: Custom::GetLowercase
    Properties:
      ServiceToken: !GetAtt GetAdjustedStackNameFunction.Arn
      InputString: !Ref AWS::StackName

  # Custom resource to transform comma separated url list to an array of url objects for Web Crawler.
  GetSeedUrlsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access as it only interacts with AWS services via APIs
          - id: W92
            reason: Function does not require reserved concurrency as it scales based on demand
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      InlineCode: |
        import cfnresponse
        import time
        def handler(event, context):
          print(event)
          urls = event['ResourceProperties'].get('WebCrawlerURLs', '').split(',')
          seedUrls = [{'Url': url.strip()} for url in urls]
          responseData = {'SeedUrls': seedUrls}
          cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)

  GetSeedUrls:
    Type: Custom::GetSeedUrls
    Properties:
      ServiceToken: !GetAtt GetSeedUrlsFunction.Arn
      WebCrawlerURLs: !Ref pWebCrawlerURLs

  # Generate short S3 vector bucket name using hash
  GetS3VectorBucketNameFunction:
    Type: AWS::Serverless::Function
    Condition: UseS3Vectors
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access
          - id: W92
            reason: Function does not require reserved concurrency
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency"
    Properties:
      Handler: index.handler
      Runtime: python3.12
      Timeout: 30
      InlineCode: |
        import cfnresponse
        import hashlib
        def handler(event, context):
            try:
                stack_name = event['ResourceProperties'].get('StackName', '')
                # Create a 12-char hash to ensure uniqueness
                hash_suffix = hashlib.sha256(stack_name.encode()).hexdigest()[:12]
                # Generate bucket name: lma-s3v-{hash} = max 20 chars
                bucket_name = f"lma-s3v-{hash_suffix}"
                responseData = {'BucketName': bucket_name}
                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)
            except Exception as e:
                cfnresponse.send(event, context, cfnresponse.FAILED, {}, reason=str(e))

  S3VectorBucketName:
    Type: Custom::GetS3VectorBucketName
    Condition: UseS3Vectors
    Properties:
      ServiceToken: !GetAtt GetS3VectorBucketNameFunction.Arn
      StackName: !Ref AWS::StackName

  #
  # S3 Vectors Resources (Native CloudFormation)
  #
  S3VectorBucket:
    Type: AWS::S3Vectors::VectorBucket
    Condition: UseS3Vectors
    DeletionPolicy: !If [ShouldRetainDataOnDelete, Retain, Delete]
    UpdateReplacePolicy: Retain
    Properties:
      VectorBucketName: !If
        - HasS3VectorBucketName
        - !Ref pS3VectorBucketName
        - !GetAtt S3VectorBucketName.BucketName

  S3VectorIndex:
    Type: AWS::S3Vectors::Index
    Condition: UseS3Vectors
    DependsOn:
      - S3VectorBucket
      - S3VectorBucketName
    Properties:
      VectorBucketName: !If
        - HasS3VectorBucketName
        - !Ref pS3VectorBucketName
        - !GetAtt S3VectorBucketName.BucketName
      IndexName: !Ref pS3VectorIndexName
      DataType: float32
      Dimension: 1024
      DistanceMetric: cosine
      MetadataConfiguration:
        NonFilterableMetadataKeys:
          - "AMAZON_BEDROCK_METADATA"
          - "AMAZON_BEDROCK_TEXT_CHUNK"

  #
  # OpenSearch Serverless resources (EXISTING - now conditional)
  #
  OSSCollection:
    Type: "AWS::OpenSearchServerless::Collection"
    Condition: UseOpenSearchServerless
    DeletionPolicy: !If [ShouldRetainDataOnDelete, Retain, Delete]
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub "${AdjustedStackName.OutputString}"
      Type: VECTORSEARCH
      Description: Bedrock Knowledge Base collection
    DependsOn: OSSEncryptionPolicy

  OSSEncryptionPolicy:
    Type: "AWS::OpenSearchServerless::SecurityPolicy"
    Condition: UseOpenSearchServerless
    Properties:
      Name: !Sub "${AdjustedStackName.OutputString}"
      Type: encryption
      Description: Encryption policy for Bedrock Knowledge Base collection
      Policy: !Sub
        - '{"Rules":[{"ResourceType":"collection","Resource":["collection/${CollName}"]}],"AWSOwnedKey":true}'
        - CollName: !Sub "${AdjustedStackName.OutputString}"

  OSSNetworkPolicy:
    Type: AWS::OpenSearchServerless::SecurityPolicy
    Condition: UseOpenSearchServerless
    DependsOn:
      - OSSEncryptionPolicy
    Properties:
      Name: !Sub "${AdjustedStackName.OutputString}"
      Type: network
      Policy: !Sub
        - '[{"Description": "Public access for Bedrock Knowledge Base collection",
          "Rules": [{"ResourceType": "dashboard", "Resource": ["collection/${CollName}"]},
          {"ResourceType": "collection", "Resource": ["collection/${CollName}"]}],
          "AllowFromPublic": true}]'
        - CollName: !Sub "${AdjustedStackName.OutputString}"

  OSSDataAccessPolicy:
    Type: AWS::OpenSearchServerless::AccessPolicy
    Condition: UseOpenSearchServerless
    DependsOn:
      - OSSNetworkPolicy
    Properties:
      Name: !Sub "${AdjustedStackName.OutputString}"
      Type: data
      Policy: !Sub
        - '[{"Rules": [{"Resource": ["collection/${CollName}"], "Permission":
          ["aoss:CreateCollectionItems", "aoss:UpdateCollectionItems", "aoss:DescribeCollectionItems"],
          "ResourceType": "collection"}, {"ResourceType": "index", "Resource": ["index/${CollName}/*"],
          "Permission": ["aoss:CreateIndex", "aoss:DescribeIndex", "aoss:ReadDocument",
          "aoss:WriteDocument", "aoss:UpdateIndex", "aoss:DeleteIndex"]}],
          "Principal": ["arn:aws:iam::${AWS::AccountId}:role/${KnowledgeBaseServiceRole}"]}]'
        - CollName: !Sub "${AdjustedStackName.OutputString}"

  #
  # Custom resource code to initialize OpenSearch Serverless index
  #
  OpenSearchPyLayer:
    Type: AWS::Lambda::LayerVersion
    Condition: UseOpenSearchServerless
    Properties:
      CompatibleRuntimes:
        - python3.12
      Content: ./opensearchpy_layer
      Description: opensearchpy layer including requests, requests-aws4auth, and boto3-1.34.82
      LicenseInfo: Apache-2.0

  OSSSetupLambdaFunctionRole:
    Type: AWS::IAM::Role
    Condition: UseOpenSearchServerless
    DependsOn:
      - OpenSearchPyLayer
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      PermissionsBoundary: !If
        - HasPermissionsBoundary
        - !Ref PermissionsBoundaryArn
        - !Ref AWS::NoValue
      Policies:
        - PolicyName: OSSLambdaRoleDefaultPolicy # Reference: https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsx-ray.html
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - xray:PutTelemetryRecords
                  - xray:PutTraceSegments
                Resource: "*"
        - PolicyName: AllowLambdaLogs # Reference: https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudwatchlogs.html
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        - PolicyName: AllowS3 # Reference: https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazons3.html
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject*
                  - s3:GetObject*
                  - s3:DeleteObject*
                Resource:
                  Fn::Sub: arn:aws:s3:::*
        - PolicyName: AOSSPermissionsPart1 # References: https://docs.aws.amazon.com/opensearch-service/latest/developerguide/security-iam-serverless.html, https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonopensearchserverless.html
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - aoss:BatchGetCollection
                  - aoss:CreateSecurityPolicy
                  - aoss:CreateAccessPolicy
                  - aoss:UpdateAccessPolicy
                  - aoss:ListCollections
                  - aoss:GetAccessPolicy
                  - aoss:ListCollections
                  - aoss:CreateCollection
                Resource: "*"
        - PolicyName: AOSSPermissionsPart2
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - aoss:DeleteCollection
                  - aoss:UpdateCollection
                  - aoss:APIAccessAll
                Resource: !GetAtt OSSCollection.Arn

  OSSSetupLambdaFunction:
    Type: AWS::Lambda::Function
    Condition: UseOpenSearchServerless
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access as it only interacts with AWS services via APIs
          - id: W92
            reason: Function does not require reserved concurrency as it scales based on demand
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    DependsOn:
      - OSSSetupLambdaFunctionRole
    Properties:
      Handler: oss_handler.lambda_handler
      MemorySize: 1024
      Role:
        Fn::GetAtt:
          - OSSSetupLambdaFunctionRole
          - Arn
      Runtime: python3.12
      Timeout: 840
      Code: ./src/oss_setup
      Layers:
        - Ref: OpenSearchPyLayer
        - !Sub arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:68
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: InfraSetupLambda
          POWERTOOLS_METRICS_NAMESPACE: InfraSetupLambda-NameSpace
          POWERTOOLS_LOG_LEVEL: INFO

  OSSIndexCustomResourceFunctionRole:
    Type: AWS::IAM::Role
    Condition: UseOpenSearchServerless
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      PermissionsBoundary: !If
        - HasPermissionsBoundary
        - !Ref PermissionsBoundaryArn
        - !Ref AWS::NoValue
      Policies:
        - PolicyName: OSSIndexCustomResourceFunctionRoleDefaultPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - Fn::GetAtt:
                      - OSSSetupLambdaFunction
                      - Arn
                  - Fn::Join:
                      - ""
                      - - Fn::GetAtt:
                            - OSSSetupLambdaFunction
                            - Arn
                        - :*
        - PolicyName: XRayTracingPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - xray:PutTelemetryRecords
                  - xray:PutTraceSegments
                Resource: "*"

  OSSIndexCustomResourceFunction:
    Type: AWS::Lambda::Function
    Condition: UseOpenSearchServerless
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access as it only interacts with AWS services via APIs
          - id: W92
            reason: Function does not require reserved concurrency as it scales based on demand
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    Properties:
      Handler: framework.onEvent
      MemorySize: 1024
      Role:
        Fn::GetAtt:
          - OSSIndexCustomResourceFunctionRole
          - Arn
      Runtime: nodejs22.x
      Timeout: 900
      Code: ./src/oss_custom_resource
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          USER_ON_EVENT_FUNCTION_ARN:
            Fn::GetAtt:
              - OSSSetupLambdaFunction
              - Arn

  OSSIndexCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Condition: UseOpenSearchServerless
    DependsOn:
      - OSSIndexCustomResourceFunction
      - OSSDataAccessPolicy
    Properties:
      ServiceToken: !GetAtt OSSIndexCustomResourceFunction.Arn
      collection_endpoint: !GetAtt OSSCollection.CollectionEndpoint
      data_access_policy_name: !Sub "${AdjustedStackName.OutputString}"
      index_name:
        Ref: pIndexName
      embedding_model_id:
        Ref: pEmbedModel
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  #
  # IAM Role used by the Bedrock service to access S3, OpenSearch, and embedding models
  #
  KnowledgeBaseServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - bedrock.amazonaws.com
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Sub ${AWS::AccountId}
              ArnLike:
                aws:SourceArn: !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*
      Policies:
        - PolicyName: bedrock-invoke-model
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: BedrockInvokeModel
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/*
        - !If
          - UseOpenSearchServerless
          - PolicyName: oss-api-access
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Sid: OpenSearchServerlessAPIAccessAll
                  Effect: Allow
                  Action:
                    - aoss:APIAccessAll
                  Resource: !GetAtt OSSCollection.Arn
          - !Ref "AWS::NoValue"
        - !If
          - UseS3Vectors
          - PolicyName: s3-vectors-access
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Sid: S3VectorsAccess
                  Effect: Allow
                  Action:
                    - s3vectors:GetIndex
                    - s3vectors:QueryVectors
                    - s3vectors:PutVectors
                    - s3vectors:GetVectors
                    - s3vectors:DeleteVectors
                  Resource: !GetAtt S3VectorIndex.IndexArn
          - !Ref "AWS::NoValue"
        - !If
          - IsS3DataSource
          - PolicyName: s3-read-objects
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Sid: S3ListBucket
                  Effect: Allow
                  Action:
                    - s3:ListBucket
                  Resource: !If
                    - UseS3Vectors
                    - - !Sub "arn:aws:s3:::${pKnowledgeBaseBucketName}"
                      - !GetAtt S3VectorBucket.VectorBucketArn
                    - - !Sub "arn:aws:s3:::${pKnowledgeBaseBucketName}"
                - Sid: S3GetObject
                  Effect: Allow
                  Action:
                    - s3:GetObject
                  Resource: !If
                    - UseS3Vectors
                    - - !Sub "arn:aws:s3:::${pKnowledgeBaseBucketName}/*"
                      - !Sub "${S3VectorBucket.VectorBucketArn}/*"
                    - - !Sub "arn:aws:s3:::${pKnowledgeBaseBucketName}/*"
          - !Ref "AWS::NoValue"

  #
  # Bedrock Knowledge Base resources (conditional based on vector store type)
  #
  KnowledgeBaseOpenSearch:
    Type: AWS::Bedrock::KnowledgeBase
    Condition: UseOpenSearchServerless
    DependsOn:
      - OSSIndexCustomResource
    Properties:
      Description: LMA Bedrock Knowledge Base with OpenSearch Serverless
      KnowledgeBaseConfiguration:
        Type: VECTOR
        VectorKnowledgeBaseConfiguration:
          EmbeddingModelArn:
            Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/${pEmbedModel}
      Name: !Sub "${AWS::StackName}-OpenSearch"
      RoleArn: !GetAtt KnowledgeBaseServiceRole.Arn
      StorageConfiguration:
        Type: OPENSEARCH_SERVERLESS
        OpensearchServerlessConfiguration:
          CollectionArn: !GetAtt OSSCollection.Arn
          FieldMapping:
            MetadataField:
              Ref: pMetaDataFieldName
            TextField:
              Ref: pTextFieldName
            VectorField:
              Ref: pVectorFieldName
          VectorIndexName:
            Ref: pIndexName

  KnowledgeBaseS3Vectors:
    Type: AWS::Bedrock::KnowledgeBase
    Condition: UseS3Vectors
    DependsOn:
      - S3VectorIndex
    Properties:
      Name: !Sub "${AWS::StackName}-S3Vectors"
      Description: "LMA Bedrock Knowledge Base with S3 Vectors"
      RoleArn: !GetAtt KnowledgeBaseServiceRole.Arn
      KnowledgeBaseConfiguration:
        Type: VECTOR
        VectorKnowledgeBaseConfiguration:
          EmbeddingModelArn: !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${pEmbedModel}"
      StorageConfiguration:
        Type: S3_VECTORS
        S3VectorsConfiguration:
          IndexArn: !GetAtt S3VectorIndex.IndexArn

  # Unified KB ID reference for data sources and outputs
  KnowledgeBaseIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "${AWS::StackName}-KnowledgeBaseId"
      Type: String
      Value: !If
        - UseS3Vectors
        - !Ref KnowledgeBaseS3Vectors
        - !Ref KnowledgeBaseOpenSearch
      Description: Unified Knowledge Base ID (works with either vector store)

  S3KBDataSource:
    Type: AWS::Bedrock::DataSource
    Condition: IsS3DataSource
    DependsOn:
      - KnowledgeBaseIdParameter
    Properties:
      DataDeletionPolicy: DELETE
      DataSourceConfiguration:
        Type: S3
        S3Configuration:
          BucketArn:
            Fn::Sub: arn:aws:s3:::${pKnowledgeBaseBucketName}
          InclusionPrefixes:
            Fn::If:
              - HasInputDocumentUploadFolderPrefix
              - !Split [",", Ref: pInputDocumentUploadFolderPrefix]
              - Ref: AWS::NoValue
      Description: S3 Knowledge Base Data Source
      KnowledgeBaseId: !GetAtt KnowledgeBaseIdParameter.Value
      Name: !Sub "S3DataSource-${AWS::StackName}"
      VectorIngestionConfiguration:
        ChunkingConfiguration:
          ChunkingStrategy:
            Fn::If:
              - IsChunkingStrategyFixedOrDefault
              - FIXED_SIZE
              - NONE
          FixedSizeChunkingConfiguration:
            MaxTokens:
              Fn::If:
                - IsChunkingStrategyFixed
                - Ref: pMaxTokens
                - Fn::If:
                    - IsChunkingStrategyDefault
                    - 300
                    - Ref: AWS::NoValue
            OverlapPercentage:
              Fn::If:
                - IsChunkingStrategyFixed
                - Ref: pOverlapPercentage
                - Fn::If:
                    - IsChunkingStrategyDefault
                    - 20
                    - Ref: AWS::NoValue

  WebKBDataSource:
    Type: AWS::Bedrock::DataSource
    Condition: ShouldCreateWebDataSource
    DependsOn:
      - KnowledgeBaseIdParameter
    Properties:
      DataDeletionPolicy: DELETE
      DataSourceConfiguration:
        Type: WEB
        WebConfiguration:
          CrawlerConfiguration:
            CrawlerLimits:
              RateLimit: 300
            Scope: !If
              - HasWebCrawlerScope
              - Ref: pWebCrawlerScope
              - Ref: AWS::NoValue
          SourceConfiguration:
            UrlConfiguration:
              SeedUrls: !GetAtt GetSeedUrls.SeedUrls
      Description: Web Knowledge Base Data Source
      KnowledgeBaseId: !GetAtt KnowledgeBaseIdParameter.Value
      Name: !Sub "WebKBDataSource-${AWS::StackName}"
      VectorIngestionConfiguration:
        ChunkingConfiguration:
          ChunkingStrategy:
            Fn::If:
              - IsChunkingStrategyFixedOrDefault
              - FIXED_SIZE
              - NONE
          FixedSizeChunkingConfiguration:
            MaxTokens:
              Fn::If:
                - IsChunkingStrategyFixed
                - Ref: pMaxTokens
                - Fn::If:
                    - IsChunkingStrategyDefault
                    - 300
                    - Ref: AWS::NoValue
            OverlapPercentage:
              Fn::If:
                - IsChunkingStrategyFixed
                - Ref: pOverlapPercentage
                - Fn::If:
                    - IsChunkingStrategyDefault
                    - 20
                    - Ref: AWS::NoValue

  # Start sync jobs for datasources
  StartIngestionJobFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      PermissionsBoundary: !If
        - HasPermissionsBoundary
        - !Ref PermissionsBoundaryArn
        - !Ref AWS::NoValue
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "bedrock:StartIngestionJob"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:knowledge-base/${KnowledgeBaseIdParameter.Value}"
          PolicyName: BedrockPolicy

  StartIngestionJobFunction:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Function does not require VPC access as it only interacts with AWS services via APIs
          - id: W92
            reason: Function does not require reserved concurrency as it scales based on demand
    # checkov:skip=CKV_AWS_116: "DLQ not required for Cfn Custom Resource function"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      Handler: handler.lambda_handler
      Role: !GetAtt "StartIngestionJobFunctionRole.Arn"
      Runtime: python3.12
      Timeout: 600
      MemorySize: 128
      Code: ./src/start_ingestion_job_custom_resource
      TracingConfig:
        Mode: Active

  StartWebIngestionJob:
    Type: AWS::CloudFormation::CustomResource
    Condition: ShouldCreateWebDataSource
    Properties:
      ServiceToken: !GetAtt StartIngestionJobFunction.Arn
      knowledgeBaseId: !GetAtt KnowledgeBaseIdParameter.Value
      dataSourceId: !GetAtt WebKBDataSource.DataSourceId

  StartS3IngestionJob:
    Type: AWS::CloudFormation::CustomResource
    Condition: IsS3DataSource
    Properties:
      ServiceToken: !GetAtt StartIngestionJobFunction.Arn
      knowledgeBaseId: !GetAtt KnowledgeBaseIdParameter.Value
      dataSourceId: !GetAtt S3KBDataSource.DataSourceId

  # EventBridge schedulers for data sources
  S3KBDataSourceScheduler:
    Type: AWS::Scheduler::Schedule
    Condition: IsS3DataSource
    Properties:
      Description: "Rule to start LMA Bedrock KB S3 datasource ingestion job on a schedule"
      FlexibleTimeWindow: 
        Mode: "OFF"
      ScheduleExpression: !Ref pS3SyncScheduleExpression
      ScheduleExpressionTimezone: "UTC"
      State: "ENABLED"
      Target:
        Arn: "arn:aws:scheduler:::aws-sdk:bedrockagent:startIngestionJob"
        RoleArn: !GetAtt  KBDataSourceSchedulerRole.Arn
        Input: !Sub |
              {
                "DataSourceId": "${S3KBDataSource.DataSourceId}",
                "KnowledgeBaseId": "${KnowledgeBaseIdParameter.Value}"
              }

  # EventBridge schedulers for data sources
  WebKBDataSourceScheduler:
    Type: AWS::Scheduler::Schedule
    Condition: ShouldCreateWebDataSource
    Properties:
      Description: "Rule to start LMA Bedrock KB S3 datasource ingestion job on a schedule"
      FlexibleTimeWindow: 
        Mode: "OFF"
      ScheduleExpression: !Ref pWebSyncScheduleExpression
      ScheduleExpressionTimezone: "UTC"
      State: "ENABLED"
      Target:
        Arn: "arn:aws:scheduler:::aws-sdk:bedrockagent:startIngestionJob"
        RoleArn: !GetAtt  KBDataSourceSchedulerRole.Arn
        Input: !Sub |
              {
                "DataSourceId": "${WebKBDataSource.DataSourceId}",
                "KnowledgeBaseId": "${KnowledgeBaseIdParameter.Value}"
              }

  KBDataSourceSchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BedrockAgentStartIngestionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "bedrock:StartIngestionJob"
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:knowledge-base/${KnowledgeBaseIdParameter.Value}"

Outputs:
  KnowledgeBaseS3BucketName:
    Value: !Ref pKnowledgeBaseBucketName
    Description: Knowledge Base S3 data source bucket name
  KnowledgeBaseWebCrawlerUrls:
    Value: !Ref pWebCrawlerURLs
    Description: Knowledge Base Web Crawler data source urls
  KnowledgeBaseID:
    Value: !GetAtt KnowledgeBaseIdParameter.Value
    Description: Knowledge Base ID (works with either vector store)
  
  KnowledgeBaseVectorStore:
    Value: !Ref pVectorStoreType
    Description: Vector store type used (S3_VECTORS or OPENSEARCH_SERVERLESS)
  
  S3VectorBucketName:
    Condition: UseS3Vectors
    Value: !Ref S3VectorBucket
    Description: S3 Vector bucket name (S3 Vectors only)
  
  S3VectorBucketArn:
    Condition: UseS3Vectors
    Value: !GetAtt S3VectorBucket.VectorBucketArn
    Description: S3 Vector bucket ARN (S3 Vectors only)
  
  S3VectorIndexArn:
    Condition: UseS3Vectors
    Value: !GetAtt S3VectorIndex.IndexArn
    Description: S3 Vector index ARN (S3 Vectors only)
  
  OpenSearchCollectionName:
    Condition: UseOpenSearchServerless
    Value: !Ref OSSCollection
    Description: OpenSearch collection (OpenSearch Serverless only)
  
  OpenSearchCollectionArn:
    Condition: UseOpenSearchServerless
    Value: !GetAtt OSSCollection.Arn
    Description: OpenSearch collection ARN (OpenSearch Serverless only)
  
  OpenSearchCollectionEndpoint:
    Condition: UseOpenSearchServerless
    Value: !GetAtt OSSCollection.CollectionEndpoint
    Description: OpenSearch collection endpoint (OpenSearch Serverless only)
  
  OpenSearchCollectionDashboard:
    Condition: UseOpenSearchServerless
    Value: !GetAtt OSSCollection.DashboardEndpoint
    Description: OpenSearch collection dashboard endpoint (OpenSearch Serverless only)
